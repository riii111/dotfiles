#!/usr/bin/env bash
set -euo pipefail
# ========== 1) .dbx.tomlでDSNを解決 ==========
[[ ! -f ".dbx.toml" ]] && { echo ".dbx.tomlが見つかりません"; exit 1; }

# default名
prof="$(yq -p=toml -oy '.default // "default"' .dbx.toml)"

# -p <profile> 指定で上書き
while getopts "p:" opt; do
  case $opt in
    p) prof="$OPTARG" ;;
  esac
done
shift $((OPTIND-1))

DSN="$(yq -p=toml -oy ".profiles.\"${prof}\".dsn // \"\"" .dbx.toml)"
[[ -z "${DSN}" ]] && { echo "DSNが見つかりません（.dbx.tomlのprofiles.${prof}.dsnを確認してね）"; exit 1; }

# ========== 2) テーブル一覧 ==========
scheme="${DSN%%:*}"
if [[ "$scheme" =~ ^postgres ]]; then
  # --- Postgres ---
  list_sql="\
SELECT table_schema||'.'||table_name
FROM information_schema.tables
WHERE table_type='BASE TABLE' AND table_schema NOT IN ('pg_catalog','information_schema')
ORDER BY 1;"
  preview_sql='
-- columns
SELECT column_name AS col, data_type AS type, is_nullable AS nulls
FROM information_schema.columns
WHERE table_schema = '\''__SCH__'\'' AND table_name = '\''__TBL__'\''
ORDER BY ordinal_position;
-- outbound FKs
SELECT tc.table_name AS from_tbl, kcu.column_name AS from_col,
       ccu.table_name AS to_tbl, ccu.column_name AS to_col
FROM information_schema.table_constraints tc
JOIN information_schema.key_column_usage kcu
  ON tc.constraint_name = kcu.constraint_name AND tc.table_schema = '\''__SCH__'\'' AND tc.table_name = '\''__TBL__'\''
JOIN information_schema.constraint_column_usage ccu
  ON ccu.constraint_name = tc.constraint_name AND ccu.table_schema = '\''__SCH__'\'' AND ccu.table_name = '\''__TBL__'\'';
-- inbound FKs
SELECT tc.table_name AS to_tbl, kcu.column_name AS to_col,
       ccu.table_name AS from_tbl, ccu.column_name AS from_col
FROM information_schema.table_constraints tc
JOIN information_schema.key_column_usage kcu
  ON tc.constraint_name = kcu.constraint_name
JOIN information_schema.constraint_column_usage ccu
  ON ccu.constraint_name = tc.constraint_name
WHERE ccu.table_schema = '\''__SCH__'\'' AND ccu.table_name = '\''__TBL__'\''
ORDER BY 1,2;'
  tables="$(psql "$DSN" -X -At -F $'\t' -c "$list_sql")"
  export DBN_DSN="$DSN"
  printf "%s\n" "$tables" | fzf --prompt='table> ' --preview='
TABLE={}
SCH="${TABLE%%.*}"
TBL="${TABLE#*.}"
SQL=$(cat <<'"'"'EOS'"'"'
'"$preview_sql"'
EOS
)
SQL=${SQL//__SCH__/$SCH}
SQL=${SQL//__TBL__/$TBL}
PAGER=cat psql "$DBN_DSN" -X -q -P pager=off -P linestyle=unicode -P border=2 -c "$SQL"
' --bind 'enter:execute(echo "SELECT * FROM {} LIMIT 50;" | pbcopy)+abort'
elif [[ "$scheme" == "mysql" || "$scheme" == "mariadb" ]]; then
  # --- MySQL/MariaDB ---
  # DSN 解析（mysql://user:pass@host:port/db）
  _rest="${DSN#mysql://}"
  _userpass="${_rest%%@*}"; _hostdb="${_rest#*@}"
  _user="${_userpass%%:*}"; _pass="${_userpass#*:}"
  _hostport="${_hostdb%%/*}"; _db="${_hostdb#*/}"
  _host="${_hostport%%:*}"; _port="${_hostport##*:}"
  [[ "$_host" == "$_port" ]] && _port="3306"
  [[ "$_host" == "localhost" ]] && _host="127.0.0.1"

  list_sql="SELECT CONCAT(DATABASE(),'.',TABLE_NAME)
FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_TYPE='BASE TABLE' AND TABLE_SCHEMA = DATABASE()
ORDER BY 1;"
  preview_sql="
-- columns
SELECT COLUMN_NAME AS col, COLUMN_TYPE AS type, IS_NULLABLE AS nulls
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_SCHEMA = '\$SCH' AND TABLE_NAME = '\$TBL'
ORDER BY ORDINAL_POSITION;
-- outbound FKs
SELECT kcu.TABLE_NAME AS from_tbl, kcu.COLUMN_NAME AS from_col,
       kcu.REFERENCED_TABLE_NAME AS to_tbl, kcu.REFERENCED_COLUMN_NAME AS to_col
FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE kcu
WHERE kcu.TABLE_SCHEMA = '\$SCH'
  AND kcu.TABLE_NAME   = '\$TBL'
  AND kcu.REFERENCED_TABLE_NAME IS NOT NULL
ORDER BY 1,2;
-- inbound FKs
SELECT kcu2.TABLE_NAME AS to_tbl, kcu2.COLUMN_NAME AS to_col,
       kcu2.TABLE_NAME AS from_tbl, kcu2.COLUMN_NAME AS from_col
FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE kcu2
WHERE kcu2.REFERENCED_TABLE_SCHEMA = '\$SCH'
  AND kcu2.REFERENCED_TABLE_NAME   = '\$TBL'
ORDER BY 1,2;"
  tables="$(MYSQL_PWD="$_pass" mysql --protocol=TCP --batch --skip-column-names --raw -h "$_host" -P "$_port" -u "$_user" -D "$_db" -e "$list_sql")"
  printf "%s\n" "$tables" | fzf --prompt='table> ' --preview="
TABLE={}; SCH=\${TABLE%%.*}; TBL=\${TABLE#*.};
MYSQL_PWD=\"$_pass\" mysql --protocol=TCP --table -h \"$_host\" -P \"$_port\" -u \"$_user\" -D \"$_db\" -e \"${preview_sql}\"
" --bind 'enter:execute(echo "SELECT * FROM {} LIMIT 50;" | pbcopy)+abort'
else
  echo "対応していないスキームです: $scheme"; exit 1
fi
