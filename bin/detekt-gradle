#!/bin/bash
# detekt-gradle: Run detekt with type resolution using Gradle's classpath

set -e

show_help() {
    cat << 'EOF'
dtk - Run detekt with type resolution

USAGE:
    dtk <module> [path]
    dtk --diff <module> [base-branch]
    dtk --help

EXAMPLES:
    # Check entire module
    dtk :share

    # Check specific directory
    dtk :share src/main/kotlin/v2/adobeacrobatsign/

    # Check only files changed in current PR (vs master)
    dtk --diff :share

    # Check only files changed vs specific branch
    dtk --diff :share develop

    # Generate HTML report
    dtk :share --report html:report.html

OPTIONS:
    --help       Show this help message
    --diff       Check only files changed compared to base branch (default: master)

NOTES:
    - Must be run from a Gradle project directory (where gradlew exists)
    - First run is slow due to Gradle classpath resolution
    - Config file: ~/.config/detekt/detekt.yml
EOF
    exit 0
}

# Help flag
if [[ "$1" == "--help" || "$1" == "-h" ]]; then
    show_help
fi

# Diff mode
DIFF_MODE=false
BASE_BRANCH="master"
if [[ "$1" == "--diff" ]]; then
    DIFF_MODE=true
    shift
fi

MODULE="${1:?Usage: detekt-gradle <module> [path] or detekt-gradle --diff <module> [base-branch]}"
shift || true

# Dotfiles paths
DOTFILES_DIR="${HOME}/ghq/github.com/riii111/dotfiles"
CLASSPATH_SCRIPT="${DOTFILES_DIR}/config/detekt/print-classpath.gradle.kts"
CONFIG_FILE="${DOTFILES_DIR}/config/detekt/detekt.yml"

# Fallback to XDG config if dotfiles not found
if [[ ! -f "$CONFIG_FILE" ]]; then
    CONFIG_FILE="${XDG_CONFIG_HOME:-$HOME/.config}/detekt/detekt.yml"
fi

# Find Gradle project root
GRADLE_ROOT="$(pwd)"
while [[ ! -f "$GRADLE_ROOT/gradlew" && "$GRADLE_ROOT" != "/" ]]; do
    GRADLE_ROOT="$(dirname "$GRADLE_ROOT")"
done

if [[ ! -f "$GRADLE_ROOT/gradlew" ]]; then
    echo "Error: Could not find gradlew. Run from a Gradle project directory." >&2
    exit 1
fi

# Get classpath from Gradle
echo "Getting classpath for $MODULE..." >&2
CLASSPATH=$(cd "$GRADLE_ROOT" && ./gradlew "${MODULE}:printClasspath" -I "$CLASSPATH_SCRIPT" -q 2>/dev/null | tr '\n' ':')

if [[ -z "$CLASSPATH" ]]; then
    echo "Error: Could not get classpath for $MODULE" >&2
    exit 1
fi

# Resolve module path
MODULE_PATH="${MODULE//:/ }"
MODULE_PATH="${MODULE_PATH// //}"
MODULE_SRC_DIR="$GRADLE_ROOT/$MODULE_PATH/src/main/kotlin"

if [[ "$DIFF_MODE" == true ]]; then
    # Diff mode: get changed .kt files
    if [[ -n "$1" && "$1" != --* ]]; then
        BASE_BRANCH="$1"
        shift
    fi

    echo "Getting changed Kotlin files vs $BASE_BRANCH..." >&2
    CHANGED_FILES=$(cd "$GRADLE_ROOT" && git diff --name-only "$BASE_BRANCH"...HEAD -- "$MODULE_PATH/src/main/kotlin" 2>/dev/null | grep '\.kt$' || true)

    if [[ -z "$CHANGED_FILES" ]]; then
        echo "No Kotlin files changed in $MODULE_PATH" >&2
        exit 0
    fi

    # Convert to absolute paths, comma-separated
    INPUT_FILES=""
    while IFS= read -r file; do
        if [[ -f "$GRADLE_ROOT/$file" ]]; then
            INPUT_FILES="${INPUT_FILES:+$INPUT_FILES,}$GRADLE_ROOT/$file"
        fi
    done <<< "$CHANGED_FILES"

    echo "Checking $(echo "$CHANGED_FILES" | wc -l | tr -d ' ') changed files..." >&2
    SOURCE_DIR="$INPUT_FILES"
else
    # Normal mode
    INPUT="${1:-.}"
    if [[ "$INPUT" != "." && "$INPUT" != "./" && "$INPUT" != --* ]]; then
        SOURCE_DIR="$GRADLE_ROOT/$MODULE_PATH/$INPUT"
        shift || true
    else
        SOURCE_DIR="$MODULE_SRC_DIR"
        [[ "$INPUT" != --* ]] && shift || true
    fi
fi

echo "Running detekt on $SOURCE_DIR with type resolution..." >&2

# Run detekt with classpath
exec detekt \
    --input "$SOURCE_DIR" \
    --classpath "$CLASSPATH" \
    --language-version 2.1 \
    --jvm-target 21 \
    --config "$CONFIG_FILE" \
    "$@"
