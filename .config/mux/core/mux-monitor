#!/usr/bin/env bash
#
# mux-monitor - Service status monitor for mux dashboard
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "$0" 2>/dev/null || echo "$0")")" && pwd)"
source "${SCRIPT_DIR}/mux-core.sh"

REFRESH_INTERVAL=1

#######################################
# Get current display mode
#######################################
get_mode() {
    tmux show-option -qv @mux_dash_mode 2>/dev/null || echo "all"
}

#######################################
# Get pane status for a window
# Returns: LIVE|READY|DEGRADED|STOP|DEAD|UNKNOWN
#######################################
get_pane_status() {
    local window_name="$1"
    local pane_info

    pane_info=$(tmux list-panes -t "${SESSION_NAME}:${window_name}" -F '#{pane_dead}|#{pane_dead_status}|#{pane_pid}|#{pane_current_command}' 2>/dev/null | head -1 || true)

    if [[ -z "$pane_info" ]]; then
        echo "UNKNOWN||0|"
        return
    fi

    local pane_dead pane_dead_status pane_pid pane_cmd
    IFS='|' read -r pane_dead pane_dead_status pane_pid pane_cmd <<< "$pane_info"

    if [[ "$pane_dead" == "1" ]]; then
        echo "DEAD|${pane_dead_status}|${pane_pid}|${pane_cmd}"
    elif [[ "$pane_cmd" == "zsh" || "$pane_cmd" == "bash" || "$pane_cmd" == "sh" ]]; then
        echo "STOP|0|${pane_pid}|${pane_cmd}"
    else
        # Process is running, check health
        local health
        health=$(check_health "$window_name")
        echo "${health}|0|${pane_pid}|${pane_cmd}"
    fi
}

#######################################
# Get last log line for a pane
#######################################
get_last_log() {
    local window_name="$1"
    local line

    line=$(tmux capture-pane -t "${SESSION_NAME}:${window_name}" -p 2>/dev/null | tr -d '\0' | sed 's/\x1b\[[0-9;]*m//g' | tr -s ' ' | sed '/^[[:space:]]*$/d' | tail -1 || true)
    echo "${line:0:35}"
}

#######################################
# Format service status for display
#######################################
format_service() {
    local name="$1"
    local status="$2"
    local exit_code="$3"
    local cmd="$4"
    local show_log="$5"
    local port="$6"

    local icon color summary
    case "$status" in
        LIVE)     icon="●"; color="$GREEN"; summary="live" ;;
        READY)    icon="◐"; color="$CYAN"; summary="ready" ;;
        DEGRADED) icon="▲"; color="$YELLOW"; summary="degraded" ;;
        STOP)     icon="○"; color="$DIM"; summary="stop" ;;
        DEAD)     icon="✗"; color="$RED"; summary="exit:${exit_code}" ;;
        *)        icon="?"; color="$DIM"; summary="?" ;;
    esac

    # Fixed width columns: name(12) port(6) summary(8)
    local port_display
    [[ -z "$port" || "$port" == "null" ]] && port_display="  -   " || port_display=":${port}"

    local log=""
    if [[ "$show_log" == "true" && ("$status" == "DEAD" || "$status" == "DEGRADED") ]]; then
        log=$(get_last_log "$name")
        [[ -n "$log" ]] && log=" ${DIM}│${NC} ${log}"
    fi

    printf "%b%s%b %-12.12s %b%-6s%b %b%-8s%b%s" \
        "$color" "$icon" "$NC" \
        "$name" \
        "$DIM" "$port_display" "$NC" \
        "$color" "$summary" "$NC" \
        "$log"
}

#######################################
# Render status display
#######################################
render() {
    local mode="$1"
    local output=""
    local live_count=0
    local warn_count=0
    local dead_count=0

    # Get services from config
    local services_list
    services_list=$(get_services)

    local statuses=()
    local names=()
    local exit_codes=()
    local cmds=()
    local ports=()

    for svc in $services_list; do
        local info
        info=$(get_pane_status "$svc")

        local status exit_code pid cmd
        IFS='|' read -r status exit_code pid cmd <<< "$info"

        local port
        port=$(get_service_prop "$svc" "port" "")

        statuses+=("$status")
        names+=("$svc")
        exit_codes+=("$exit_code")
        cmds+=("$cmd")
        ports+=("$port")

        case "$status" in
            LIVE) ((live_count++)) ;;
            READY|DEGRADED|STOP|UNKNOWN) ((warn_count++)) ;;
            DEAD) ((dead_count++)) ;;
        esac
    done

    # Header
    output+="${BOLD}[mux-monitor]${NC} "
    output+="${GREEN}LIVE:${live_count}${NC} "
    output+="${YELLOW}WARN:${warn_count}${NC} "
    output+="${RED}DEAD:${dead_count}${NC}  "
    output+="${DIM}[${mode}]${NC}  "
    output+="${DIM}Ctrl+b m: toggle${NC}"
    output+=$'\n\n'

    # Filter based on mode
    local display_indices=()
    for i in "${!statuses[@]}"; do
        if [[ "$mode" == "all" ]] || [[ "${statuses[$i]}" != "LIVE" ]]; then
            display_indices+=("$i")
        fi
    done

    # Single column layout
    for idx in "${display_indices[@]}"; do
        local show_log="false"
        [[ "$mode" == "bad" || "${statuses[$idx]}" != "LIVE" ]] && show_log="true"
        output+=$(format_service "${names[$idx]}" "${statuses[$idx]}" "${exit_codes[$idx]}" "${cmds[$idx]}" "$show_log" "${ports[$idx]}")
        output+=$'\n'
    done

    # Footer
    output+=$'\n'
    output+="${DIM}───────────────────────────────────────────────────────────────${NC}"$'\n'
    output+="${DIM}Docker: Window 1 | ${PROJECT_NAME} status | ${PROJECT_NAME} logs <service>${NC}"

    echo "$output"
}

#######################################
# Main loop
#######################################
main() {
    local project="${1:-}"

    if [[ -z "$project" ]]; then
        echo "Usage: mux-monitor <project>"
        exit 1
    fi

    load_config "$project" || exit 1

    if ! session_exists; then
        echo -e "${RED}Session '${SESSION_NAME}' is not running${NC}"
        exit 1
    fi

    local prev_output=""
    clear

    while true; do
        local mode
        mode=$(get_mode)

        local output
        output=$(render "$mode")

        # Only redraw if changed
        if [[ "$output" != "$prev_output" ]]; then
            clear
            echo "$output"
            prev_output="$output"
        fi

        sleep "$REFRESH_INTERVAL"
    done
}

main "$@"
